{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 04ea8a514a5c471535d1","webpack:///./~/isomorphic-fetch/fetch-npm-browserify.js","webpack:///./~/whatwg-fetch/fetch.js","webpack:///./src/index.js","webpack:///./src/utils.js","webpack:///./src/fetch.js","webpack:///./src/auth_v3.js","webpack:///./src/jsonapi.js","webpack:///./src/auth_storage.js","webpack:///./src/auth_v2.js","webpack:///./src/crud.js","webpack:///./src/doctypes.js","webpack:///./src/mango.js","webpack:///./src/files.js"],"names":["auth","crud","mango","files","AccessTokenV3","AccessToken","ClientV3","Client","AuthNone","AuthRunning","AuthError","AuthOK","mainProto","create","find","update","delete","_delete","updateAttributes","defineIndex","query","destroy","authProto","registerClient","getClient","getAuthCodeURL","getAccessToken","refreshToken","filesProto","createDirectory","updateById","updateAttributesById","updateAttributesByPath","trashById","statById","statByPath","downloadById","downloadByPath","Cozy","options","AccessTokenV2","LocalStorage","MemoryStorage","disablePromises","addToProto","init","_authstate","_authcreds","isV2","storage","creds","credentials","client","token","isV3Credentials","isV2Credentials","Error","Promise","resolve","credentialsStorage","_pageURL","pageURL","_createClient","createClient","nopCreateClient","_onRegistered","onRegistered","nopOnRegistered","url","length","slice","state","oauthFlow","reject","then","save","CredsKey","path","pathprefix","cozy","status","datasystem","undefined","protoify","context","fn","prototyped","args","ctx","obj","proto","attr","window","unpromiser","isPromise","sleep","retry","getFuzzedDelay","getBackedoffDelay","createPath","encodeQuery","decodeQuery","warn","FuzzFactor","value","apply","l","cb","res","err","time","setTimeout","count","delay","doTry","catch","retryDelay","fuzzingFactor","Math","random","retryCount","pow","doctype","id","route","encodeURIComponent","q","qname","queryIndex","indexOf","queries","fragIndex","queryStr","parts","split","i","pair","decodeURIComponent","hasOwnProperty","warned","text","push","console","cozyFetch","cozyFetchJSON","fullpath","resp","disableAuth","fetch","manualAuthCredentials","cozyFetchWithAuth","authorize","handleResponse","headers","toAuthHeader","newToken","saveCredentials","method","body","JSON","stringify","handleJSONResponse","ok","data","contentType","get","json","FetchError","reason","response","StateSize","StateKey","opts","clientID","client_id","clientSecret","client_secret","registrationAccessToken","registration_access_token","redirect_uris","redirectURI","softwareID","software_id","softwareVersion","software_version","clientName","client_name","clientKind","client_kind","clientURI","client_uri","logoURI","logo_uri","policyURI","policy_uri","tokenType","token_type","accessToken","access_token","refresh_token","scope","isRegistered","toRegisterJSON","scopes","generateRandomState","join","grantQueries","getGrantCodeFromPageURL","retrieveToken","code","clearAndRetry","clear","registerNewClient","unregisteredClient","saveCreds","doFlow","all","load","authFlow","isUnauthorised","Object","assign","location","href","buffer","crypto","getRandomValues","Uint8Array","require","randomBytes","e","Array","floor","btoa","String","fromCharCode","replace","indexKey","doc","type","findByRef","resources","ref","handleResource","rawResource","resource","_id","_type","_rev","meta","rev","attributes","relations","name","rels","relationships","isArray","map","handleTopLevel","included","forEach","r","prefix","localStorage","key","setItem","item","getItem","parse","removeItem","hash","deleted","V2TOKEN_ABORT_TIMEOUT","parent","postMessage","origin","intent","action","timeout","receiver","event","appName","removeEventListener","clearTimeout","addEventListener","NOREV","docType","changes","tries","normalizeDoctype","KNOWN_DOCTYPES","REVERSE_KNOWN","keys","k","isQualified","known","parseSelector","normalizeSelector","makeMapReduceQuery","fields","defineIndexV2","defineIndexV3","indexRef","queryV2","queryV3","VALUEOPERATORS","LOGICOPERATORS","MAP_TEMPLATE","toLowerCase","emit","FIELDSPLACEHOLDER","toString","COUCHDB_INFINITY","COUCHDB_LOWEST","indexName","capitalize","indexDefinition","makeMapFunction","reduce","use_index","selector","limit","since","sort","docs","charAt","toUpperCase","operator","acc","concat","filters","filter","op","field","applySelector","lower","upper","inclusiveEnd","startkey","endkey","inclusive_end","mrquery","firstFreeValueField","normalizedSelector","used","isFreeValue","contentTypeOctetStream","doUpload","ArrayBuffer","isBuffer","isFile","File","isBlob","Blob","isString","dirID","attrs","addIsDir","isDir"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,O;ACVA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,uBAAe;AACf;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;;;;;;;;;;;;;;ACtCA;AACA;AACA;AACA;AACA;AACA;;;;;;;ACLA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA,MAAK;AACL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,iBAAgB;AAChB;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,QAAO;;AAEP,MAAK;AACL;AACA;AACA,QAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,QAAO;AACP,MAAK;AACL;;AAEA;AACA;AACA,yCAAwC,mBAAmB;AAC3D;AACA;;AAEA;AACA;AACA,mCAAkC,oBAAoB;AACtD;AACA;;AAEA;AACA;AACA,yCAAwC,4BAA4B;AACpE;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA,QAAO;AACP;AACA,QAAO;AACP;AACA,QAAO;AACP;AACA,QAAO;AACP;AACA;AACA,QAAO;AACP;AACA;;AAEA;AACA;AACA,wDAAuD;AACvD,UAAS;AACT;AACA,UAAS;AACT,+EAA8E;AAC9E;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,UAAS;AACT;AACA,UAAS;AACT;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,UAAS;AACT;AACA,UAAS;AACT;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA;AACA,wCAAuC,0BAA0B;AACjE;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA,gCAA+B,0BAA0B,eAAe;AACxE;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,QAAO;;AAEP;AACA,MAAK;AACL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","file":"cozy-client.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"cozy-client-js\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"cozy-client-js\"] = factory();\n\telse\n\t\troot[\"cozy-client-js\"] = factory();\n})(this, function() {\nreturn \n\n\n// WEBPACK FOOTER //\n// webpack/universalModuleDefinition"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 04ea8a514a5c471535d1","// the whatwg-fetch polyfill installs the fetch() function\n// on the global object (window or self)\n//\n// Return that as the export for use in Webpack, Browserify etc.\nrequire('whatwg-fetch');\nmodule.exports = self.fetch.bind(self);\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/isomorphic-fetch/fetch-npm-browserify.js\n// module id = 1\n// module chunks = 0","(function(self) {\n  'use strict';\n\n  if (self.fetch) {\n    return\n  }\n\n  var support = {\n    searchParams: 'URLSearchParams' in self,\n    iterable: 'Symbol' in self && 'iterator' in Symbol,\n    blob: 'FileReader' in self && 'Blob' in self && (function() {\n      try {\n        new Blob()\n        return true\n      } catch(e) {\n        return false\n      }\n    })(),\n    formData: 'FormData' in self,\n    arrayBuffer: 'ArrayBuffer' in self\n  }\n\n  function normalizeName(name) {\n    if (typeof name !== 'string') {\n      name = String(name)\n    }\n    if (/[^a-z0-9\\-#$%&'*+.\\^_`|~]/i.test(name)) {\n      throw new TypeError('Invalid character in header field name')\n    }\n    return name.toLowerCase()\n  }\n\n  function normalizeValue(value) {\n    if (typeof value !== 'string') {\n      value = String(value)\n    }\n    return value\n  }\n\n  // Build a destructive iterator for the value list\n  function iteratorFor(items) {\n    var iterator = {\n      next: function() {\n        var value = items.shift()\n        return {done: value === undefined, value: value}\n      }\n    }\n\n    if (support.iterable) {\n      iterator[Symbol.iterator] = function() {\n        return iterator\n      }\n    }\n\n    return iterator\n  }\n\n  function Headers(headers) {\n    this.map = {}\n\n    if (headers instanceof Headers) {\n      headers.forEach(function(value, name) {\n        this.append(name, value)\n      }, this)\n\n    } else if (headers) {\n      Object.getOwnPropertyNames(headers).forEach(function(name) {\n        this.append(name, headers[name])\n      }, this)\n    }\n  }\n\n  Headers.prototype.append = function(name, value) {\n    name = normalizeName(name)\n    value = normalizeValue(value)\n    var list = this.map[name]\n    if (!list) {\n      list = []\n      this.map[name] = list\n    }\n    list.push(value)\n  }\n\n  Headers.prototype['delete'] = function(name) {\n    delete this.map[normalizeName(name)]\n  }\n\n  Headers.prototype.get = function(name) {\n    var values = this.map[normalizeName(name)]\n    return values ? values[0] : null\n  }\n\n  Headers.prototype.getAll = function(name) {\n    return this.map[normalizeName(name)] || []\n  }\n\n  Headers.prototype.has = function(name) {\n    return this.map.hasOwnProperty(normalizeName(name))\n  }\n\n  Headers.prototype.set = function(name, value) {\n    this.map[normalizeName(name)] = [normalizeValue(value)]\n  }\n\n  Headers.prototype.forEach = function(callback, thisArg) {\n    Object.getOwnPropertyNames(this.map).forEach(function(name) {\n      this.map[name].forEach(function(value) {\n        callback.call(thisArg, value, name, this)\n      }, this)\n    }, this)\n  }\n\n  Headers.prototype.keys = function() {\n    var items = []\n    this.forEach(function(value, name) { items.push(name) })\n    return iteratorFor(items)\n  }\n\n  Headers.prototype.values = function() {\n    var items = []\n    this.forEach(function(value) { items.push(value) })\n    return iteratorFor(items)\n  }\n\n  Headers.prototype.entries = function() {\n    var items = []\n    this.forEach(function(value, name) { items.push([name, value]) })\n    return iteratorFor(items)\n  }\n\n  if (support.iterable) {\n    Headers.prototype[Symbol.iterator] = Headers.prototype.entries\n  }\n\n  function consumed(body) {\n    if (body.bodyUsed) {\n      return Promise.reject(new TypeError('Already read'))\n    }\n    body.bodyUsed = true\n  }\n\n  function fileReaderReady(reader) {\n    return new Promise(function(resolve, reject) {\n      reader.onload = function() {\n        resolve(reader.result)\n      }\n      reader.onerror = function() {\n        reject(reader.error)\n      }\n    })\n  }\n\n  function readBlobAsArrayBuffer(blob) {\n    var reader = new FileReader()\n    reader.readAsArrayBuffer(blob)\n    return fileReaderReady(reader)\n  }\n\n  function readBlobAsText(blob) {\n    var reader = new FileReader()\n    reader.readAsText(blob)\n    return fileReaderReady(reader)\n  }\n\n  function Body() {\n    this.bodyUsed = false\n\n    this._initBody = function(body) {\n      this._bodyInit = body\n      if (typeof body === 'string') {\n        this._bodyText = body\n      } else if (support.blob && Blob.prototype.isPrototypeOf(body)) {\n        this._bodyBlob = body\n      } else if (support.formData && FormData.prototype.isPrototypeOf(body)) {\n        this._bodyFormData = body\n      } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {\n        this._bodyText = body.toString()\n      } else if (!body) {\n        this._bodyText = ''\n      } else if (support.arrayBuffer && ArrayBuffer.prototype.isPrototypeOf(body)) {\n        // Only support ArrayBuffers for POST method.\n        // Receiving ArrayBuffers happens via Blobs, instead.\n      } else {\n        throw new Error('unsupported BodyInit type')\n      }\n\n      if (!this.headers.get('content-type')) {\n        if (typeof body === 'string') {\n          this.headers.set('content-type', 'text/plain;charset=UTF-8')\n        } else if (this._bodyBlob && this._bodyBlob.type) {\n          this.headers.set('content-type', this._bodyBlob.type)\n        } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {\n          this.headers.set('content-type', 'application/x-www-form-urlencoded;charset=UTF-8')\n        }\n      }\n    }\n\n    if (support.blob) {\n      this.blob = function() {\n        var rejected = consumed(this)\n        if (rejected) {\n          return rejected\n        }\n\n        if (this._bodyBlob) {\n          return Promise.resolve(this._bodyBlob)\n        } else if (this._bodyFormData) {\n          throw new Error('could not read FormData body as blob')\n        } else {\n          return Promise.resolve(new Blob([this._bodyText]))\n        }\n      }\n\n      this.arrayBuffer = function() {\n        return this.blob().then(readBlobAsArrayBuffer)\n      }\n\n      this.text = function() {\n        var rejected = consumed(this)\n        if (rejected) {\n          return rejected\n        }\n\n        if (this._bodyBlob) {\n          return readBlobAsText(this._bodyBlob)\n        } else if (this._bodyFormData) {\n          throw new Error('could not read FormData body as text')\n        } else {\n          return Promise.resolve(this._bodyText)\n        }\n      }\n    } else {\n      this.text = function() {\n        var rejected = consumed(this)\n        return rejected ? rejected : Promise.resolve(this._bodyText)\n      }\n    }\n\n    if (support.formData) {\n      this.formData = function() {\n        return this.text().then(decode)\n      }\n    }\n\n    this.json = function() {\n      return this.text().then(JSON.parse)\n    }\n\n    return this\n  }\n\n  // HTTP methods whose capitalization should be normalized\n  var methods = ['DELETE', 'GET', 'HEAD', 'OPTIONS', 'POST', 'PUT']\n\n  function normalizeMethod(method) {\n    var upcased = method.toUpperCase()\n    return (methods.indexOf(upcased) > -1) ? upcased : method\n  }\n\n  function Request(input, options) {\n    options = options || {}\n    var body = options.body\n    if (Request.prototype.isPrototypeOf(input)) {\n      if (input.bodyUsed) {\n        throw new TypeError('Already read')\n      }\n      this.url = input.url\n      this.credentials = input.credentials\n      if (!options.headers) {\n        this.headers = new Headers(input.headers)\n      }\n      this.method = input.method\n      this.mode = input.mode\n      if (!body) {\n        body = input._bodyInit\n        input.bodyUsed = true\n      }\n    } else {\n      this.url = input\n    }\n\n    this.credentials = options.credentials || this.credentials || 'omit'\n    if (options.headers || !this.headers) {\n      this.headers = new Headers(options.headers)\n    }\n    this.method = normalizeMethod(options.method || this.method || 'GET')\n    this.mode = options.mode || this.mode || null\n    this.referrer = null\n\n    if ((this.method === 'GET' || this.method === 'HEAD') && body) {\n      throw new TypeError('Body not allowed for GET or HEAD requests')\n    }\n    this._initBody(body)\n  }\n\n  Request.prototype.clone = function() {\n    return new Request(this)\n  }\n\n  function decode(body) {\n    var form = new FormData()\n    body.trim().split('&').forEach(function(bytes) {\n      if (bytes) {\n        var split = bytes.split('=')\n        var name = split.shift().replace(/\\+/g, ' ')\n        var value = split.join('=').replace(/\\+/g, ' ')\n        form.append(decodeURIComponent(name), decodeURIComponent(value))\n      }\n    })\n    return form\n  }\n\n  function headers(xhr) {\n    var head = new Headers()\n    var pairs = (xhr.getAllResponseHeaders() || '').trim().split('\\n')\n    pairs.forEach(function(header) {\n      var split = header.trim().split(':')\n      var key = split.shift().trim()\n      var value = split.join(':').trim()\n      head.append(key, value)\n    })\n    return head\n  }\n\n  Body.call(Request.prototype)\n\n  function Response(bodyInit, options) {\n    if (!options) {\n      options = {}\n    }\n\n    this.type = 'default'\n    this.status = options.status\n    this.ok = this.status >= 200 && this.status < 300\n    this.statusText = options.statusText\n    this.headers = options.headers instanceof Headers ? options.headers : new Headers(options.headers)\n    this.url = options.url || ''\n    this._initBody(bodyInit)\n  }\n\n  Body.call(Response.prototype)\n\n  Response.prototype.clone = function() {\n    return new Response(this._bodyInit, {\n      status: this.status,\n      statusText: this.statusText,\n      headers: new Headers(this.headers),\n      url: this.url\n    })\n  }\n\n  Response.error = function() {\n    var response = new Response(null, {status: 0, statusText: ''})\n    response.type = 'error'\n    return response\n  }\n\n  var redirectStatuses = [301, 302, 303, 307, 308]\n\n  Response.redirect = function(url, status) {\n    if (redirectStatuses.indexOf(status) === -1) {\n      throw new RangeError('Invalid status code')\n    }\n\n    return new Response(null, {status: status, headers: {location: url}})\n  }\n\n  self.Headers = Headers\n  self.Request = Request\n  self.Response = Response\n\n  self.fetch = function(input, init) {\n    return new Promise(function(resolve, reject) {\n      var request\n      if (Request.prototype.isPrototypeOf(input) && !init) {\n        request = input\n      } else {\n        request = new Request(input, init)\n      }\n\n      var xhr = new XMLHttpRequest()\n\n      function responseURL() {\n        if ('responseURL' in xhr) {\n          return xhr.responseURL\n        }\n\n        // Avoid security warnings on getResponseHeader when not allowed by CORS\n        if (/^X-Request-URL:/m.test(xhr.getAllResponseHeaders())) {\n          return xhr.getResponseHeader('X-Request-URL')\n        }\n\n        return\n      }\n\n      xhr.onload = function() {\n        var options = {\n          status: xhr.status,\n          statusText: xhr.statusText,\n          headers: headers(xhr),\n          url: responseURL()\n        }\n        var body = 'response' in xhr ? xhr.response : xhr.responseText\n        resolve(new Response(body, options))\n      }\n\n      xhr.onerror = function() {\n        reject(new TypeError('Network request failed'))\n      }\n\n      xhr.ontimeout = function() {\n        reject(new TypeError('Network request failed'))\n      }\n\n      xhr.open(request.method, request.url, true)\n\n      if (request.credentials === 'include') {\n        xhr.withCredentials = true\n      }\n\n      if ('responseType' in xhr && support.blob) {\n        xhr.responseType = 'blob'\n      }\n\n      request.headers.forEach(function(value, name) {\n        xhr.setRequestHeader(name, value)\n      })\n\n      xhr.send(typeof request._bodyInit === 'undefined' ? null : request._bodyInit)\n    })\n  }\n  self.fetch.polyfill = true\n})(typeof self !== 'undefined' ? self : this);\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/whatwg-fetch/fetch.js\n// module id = 2\n// module chunks = 0","import {unpromiser, warn} from './utils'\nimport {cozyFetchJSON} from './fetch'\nimport {LocalStorage, MemoryStorage} from './auth_storage'\nimport {AccessToken as AccessTokenV2, getAccessToken as getAccessTokenV2} from './auth_v2'\nimport * as auth from './auth_v3'\nimport * as crud from './crud'\nimport * as mango from './mango'\nimport * as files from './files'\n\nconst {AccessToken: AccessTokenV3, Client: ClientV3} = auth\n\nconst AuthNone = 0\nconst AuthRunning = 1\nconst AuthError = 2\nconst AuthOK = 3\n\nconst mainProto = {\n  create: crud.create,\n  find: crud.find,\n  update: crud.update,\n  delete: crud._delete,\n  updateAttributes: crud.updateAttributes,\n  defineIndex: mango.defineIndex,\n  query: mango.query,\n  destroy: function (...args) {\n    warn('destroy is deprecated, use cozy.delete instead.')\n    return crud._delete(...args)\n  }\n}\n\nconst authProto = {\n  registerClient: auth.registerClient,\n  getClient: auth.getClient,\n  getAuthCodeURL: auth.getAuthCodeURL,\n  getAccessToken: auth.getAccessToken,\n  refreshToken: auth.refreshToken\n}\n\nconst filesProto = {\n  create: files.create,\n  createDirectory: files.createDirectory,\n  updateById: files.updateById,\n  updateAttributesById: files.updateAttributesById,\n  updateAttributesByPath: files.updateAttributesByPath,\n  trashById: files.trashById,\n  statById: files.statById,\n  statByPath: files.statByPath,\n  downloadById: files.downloadById,\n  downloadByPath: files.downloadByPath\n}\n\nclass Cozy {\n  constructor (options) {\n    this.files = {}\n    this.auth = {\n      Client: ClientV3,\n      AccessToken: AccessTokenV3,\n      AccessTokenV2: AccessTokenV2,\n      LocalStorage: LocalStorage,\n      MemoryStorage: MemoryStorage\n    }\n    const disablePromises = !!(options && options.disablePromises)\n    addToProto(this, this, mainProto, disablePromises)\n    addToProto(this, this.auth, authProto, disablePromises)\n    addToProto(this, this.files, filesProto, disablePromises)\n    this.init(options)\n  }\n\n  init (options = {}) {\n    this._authstate = AuthNone\n    this._authcreds = null\n    this.isV2 = (options.isV2 === true)\n    this.storage = null\n\n    const creds = options.credentials\n    if (creds) {\n      const {client, token} = creds\n      const isV3Credentials = (\n        (client instanceof ClientV3) &&\n        (token instanceof AccessTokenV3))\n\n      const isV2Credentials = (\n        (token instanceof AccessTokenV2))\n\n      if (this.isV2 && !isV2Credentials) {\n        throw new Error('Bad credentials')\n      }\n      if (!this.isV2 && !isV3Credentials) {\n        throw new Error('Bad credentials')\n      }\n\n      this._authstate = AuthOK\n      this._authcreds = Promise.resolve(creds)\n    }\n\n    if (options.credentialsStorage) {\n      this.storage = options.credentialsStorage\n    }\n\n    this._pageURL = options.pageURL || ''\n    this._createClient = options.createClient || nopCreateClient\n    this._onRegistered = options.onRegistered || nopOnRegistered\n\n    let url = options.url || ''\n    while (url[url.length - 1] === '/') {\n      url = url.slice(0, -1)\n    }\n\n    this.url = url\n  }\n\n  authorize () {\n    const state = this._authstate\n    if (state === AuthOK || state === AuthRunning) {\n      return this._authcreds\n    }\n\n    this._authstate = AuthRunning\n    if (this.isV2) {\n      this._authcreds = getAccessTokenV2()\n    } else if (this.storage) {\n      this._authcreds = auth.oauthFlow(\n        this,\n        this.storage,\n        this._pageURL,\n        this._createClient,\n        this._onRegistered\n      )\n    } else {\n      return Promise.reject(new Error('Missing credentials'))\n    }\n\n    this._authcreds.then(\n      () => { this._authstate = AuthOK },\n      () => { this._authstate = AuthError })\n\n    return this._authcreds\n  }\n\n  saveCredentials (client, token) {\n    const creds = {client, token}\n    if (!this.storage || this._authstate === AuthRunning) {\n      return Promise.resolve(creds)\n    }\n    this.storage.save(auth.CredsKey, creds)\n    this._authcreds = Promise.resolve(creds)\n    return this._authcreds\n  }\n\n  fullpath (path) {\n    const pathprefix = this.isV2 ? '/ds-api' : ''\n    return this.url + pathprefix + path\n  }\n\n  checkIfV2 () {\n    return cozyFetchJSON(cozy, 'GET', '/status/')\n      .then((status) => status.datasystem !== undefined)\n  }\n}\n\nfunction nopCreateClient () {\n  throw new Error('No \"createClient\" function given')\n}\n\nfunction nopOnRegistered () {}\n\nfunction protoify (context, fn) {\n  return function prototyped (...args) {\n    return fn(context, ...args)\n  }\n}\n\nfunction addToProto (ctx, obj, proto, disablePromises) {\n  for (const attr in proto) {\n    let fn = protoify(ctx, proto[attr])\n    if (disablePromises) {\n      fn = unpromiser(fn)\n    }\n    obj[attr] = fn\n  }\n}\n\nconst cozy = new Cozy()\n\nexport default cozy\nexport { Cozy, LocalStorage, MemoryStorage }\n\nif ((typeof window) !== 'undefined') {\n  window.cozy = cozy\n  window.Cozy = Cozy\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","const FuzzFactor = 0.3\n\nexport function unpromiser (fn) {\n  return function (...args) {\n    const value = fn.apply(this, args)\n    if (!isPromise(value)) {\n      return value\n    }\n    const l = args.length\n    if (l === 0 || typeof args[l - 1] !== 'function') {\n      return\n    }\n    const cb = args[l - 1]\n    value.then(\n      (res) => cb(null, res),\n      (err) => cb(err, null)\n    )\n    return\n  }\n}\n\nexport function isPromise (value) {\n  return !!value && typeof value.then === 'function'\n}\n\nexport function sleep (time, args) {\n  return new Promise((resolve) => {\n    setTimeout(resolve, time, args)\n  })\n}\n\nexport function retry (fn, count, delay = 300) {\n  return function doTry (...args) {\n    return fn(...args).catch((err) => {\n      if (--count < 0) {\n        throw err\n      }\n      return sleep(getBackedoffDelay(delay, count))\n        .then(() => doTry(...args))\n    })\n  }\n}\n\nexport function getFuzzedDelay (retryDelay) {\n  const fuzzingFactor = ((Math.random() * 2) - 1) * FuzzFactor\n  return retryDelay * (1.0 + fuzzingFactor)\n}\n\nexport function getBackedoffDelay (retryDelay, retryCount = 1) {\n  return getFuzzedDelay(retryDelay * Math.pow(2, retryCount - 1))\n}\n\nexport function createPath (cozy, doctype, id = '', query = null) {\n  let route = '/data/'\n  if (!cozy.isV2) {\n    route += `${encodeURIComponent(doctype)}/`\n  }\n  if (id !== '') {\n    route += encodeURIComponent(id)\n  }\n  const q = encodeQuery(query)\n  if (q !== '') {\n    route += '?' + q\n  }\n  return route\n}\n\nexport function encodeQuery (query) {\n  if (!query) {\n    return ''\n  }\n  let q = ''\n  for (const qname in query) {\n    if (q !== '') {\n      q += '&'\n    }\n    q += `${encodeURIComponent(qname)}=${encodeURIComponent(query[qname])}`\n  }\n  return q\n}\n\nexport function decodeQuery (url) {\n  let queryIndex = url.indexOf('?')\n  if (queryIndex < 0) {\n    queryIndex = url.length\n  }\n  const queries = {}\n  let fragIndex = url.indexOf('#')\n  if (fragIndex < 0) {\n    fragIndex = url.length\n  }\n  if (fragIndex < queryIndex) {\n    return queries\n  }\n  const queryStr = url.slice(queryIndex + 1, fragIndex)\n  if (queryStr === '') {\n    return queries\n  }\n  const parts = queryStr.split('&')\n  for (let i = 0; i < parts.length; i++) {\n    let pair = parts[i].split('=')\n    if (pair.length === 0 || pair[0] === '') {\n      continue\n    }\n    const qname = decodeURIComponent(pair[0])\n    if (queries.hasOwnProperty(qname)) {\n      continue\n    }\n    if (pair.length === 1) {\n      queries[qname] = true\n    } else if (pair.length === 2) {\n      queries[qname] = decodeURIComponent(pair[1])\n    } else {\n      throw new Error('Malformed URL')\n    }\n  }\n  return queries\n}\n\nconst warned = []\nexport function warn (text) {\n  if (warned.indexOf(text) === -1) {\n    warned.push(text)\n    console.warn('cozy-client-js', text)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/utils.js","/* global fetch */\nimport {refreshToken} from './auth_v3'\nimport {retry} from './utils'\nimport jsonapi from './jsonapi'\n\nexport function cozyFetch (cozy, path, options = {}) {\n  const fullpath = cozy.fullpath(path)\n  let resp\n  if (options.disableAuth) {\n    resp = fetch(fullpath, options)\n  } else if (options.manualAuthCredentials) {\n    resp = cozyFetchWithAuth(cozy, fullpath, options, options.manualAuthCredentials)\n  } else {\n    resp = cozy.authorize().then((credentials) =>\n      cozyFetchWithAuth(cozy, fullpath, options, credentials))\n  }\n  return resp.then(handleResponse)\n}\n\nfunction cozyFetchWithAuth (cozy, fullpath, options, credentials) {\n  const { client, token } = credentials\n  options.headers = options.headers || {}\n  options.headers['Authorization'] = token.toAuthHeader()\n\n  return fetch(fullpath, options).then((res) => {\n    if (res.status !== 401 || cozy.isV2) {\n      return res\n    }\n\n    return retry(() => refreshToken(cozy, client, token), 3)()\n      .then((newToken) => cozy.saveCredentials(client, newToken))\n      .then((credentials) => cozyFetchWithAuth(cozy, fullpath, options, credentials))\n  })\n}\n\nexport function cozyFetchJSON (cozy, method, path, body, options = {}) {\n  options.method = method\n\n  const headers = options.headers = options.headers || {}\n\n  headers['Accept'] = 'application/json'\n\n  if (body !== undefined) {\n    if (headers['Content-Type']) {\n      options.body = body\n    } else {\n      headers['Content-Type'] = 'application/json'\n      options.body = JSON.stringify(body)\n    }\n  }\n\n  return cozyFetch(cozy, path, options)\n    .then(handleJSONResponse)\n}\n\nfunction handleResponse (res) {\n  if (res.ok) {\n    return res\n  }\n  let data\n  const contentType = res.headers.get('content-type')\n  if (contentType && contentType.indexOf('json') >= 0) {\n    data = res.json()\n  } else {\n    data = res.text()\n  }\n  return data.then(err => {\n    throw new FetchError(res, err)\n  })\n}\n\nfunction handleJSONResponse (res) {\n  const contentType = res.headers.get('content-type')\n  if (!contentType || contentType.indexOf('json') < 0) {\n    return res.text((data) => {\n      throw new FetchError(res, new Error('Response is not JSON: ' + data))\n    })\n  }\n\n  const json = res.json()\n  if (contentType.indexOf('application/vnd.api+json') === 0) {\n    return json.then(jsonapi)\n  } else {\n    return json\n  }\n}\n\nexport class FetchError {\n  constructor (res, reason) {\n    this.response = res\n    this.url = res.url\n    this.status = res.status\n    this.reason = reason\n  }\n\n  isUnauthorised () {\n    return this.status === 401\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/fetch.js","/* global btoa */\nimport {encodeQuery, decodeQuery} from './utils'\nimport {cozyFetchJSON, FetchError} from './fetch'\n\nconst StateSize = 16\n\nexport const CredsKey = 'creds'\nexport const StateKey = 'state'\n\nexport class Client {\n  constructor (opts) {\n    this.clientID = opts.clientID || opts.client_id || ''\n    this.clientSecret = opts.clientSecret || opts.client_secret || ''\n    this.registrationAccessToken = opts.registrationAccessToken || opts.registration_access_token || ''\n\n    if (opts.redirect_uris) {\n      this.redirectURI = opts.redirect_uris[0] || ''\n    } else {\n      this.redirectURI = opts.redirectURI || ''\n    }\n\n    this.softwareID = opts.softwareID || opts.software_id || ''\n    this.softwareVersion = opts.softwareVersion || opts.software_version || ''\n    this.clientName = opts.clientName || opts.client_name || ''\n    this.clientKind = opts.clientKind || opts.client_kind || ''\n    this.clientURI = opts.clientURI || opts.client_uri || ''\n\n    this.logoURI = opts.logoURI || opts.logo_uri || ''\n    this.policyURI = opts.policyURI || opts.policy_uri || ''\n\n    if (this.redirectURI === '') {\n      throw new Error('Missing redirectURI field')\n    }\n    if (this.softwareID === '') {\n      throw new Error('Missing softwareID field')\n    }\n    if (this.clientName === '') {\n      throw new Error('Missing clientName field')\n    }\n  }\n\n  isRegistered () {\n    return this.clientID !== ''\n  }\n\n  toRegisterJSON () {\n    return {\n      redirect_uris: [this.redirectURI],\n      software_id: this.softwareID,\n      software_version: this.softwareVersion,\n      client_name: this.clientName,\n      client_kind: this.clientKind,\n      client_uri: this.clientURI,\n      logo_uri: this.logoURI,\n      policy_uri: this.policyURI\n    }\n  }\n\n  toAuthHeader () {\n    return 'Bearer ' + this.registrationAccessToken\n  }\n}\n\nexport class AccessToken {\n  constructor (opts) {\n    this.tokenType = opts.tokenType || opts.token_type\n    this.accessToken = opts.accessToken || opts.access_token\n    this.refreshToken = opts.refreshToken || opts.refresh_token\n    this.scope = opts.scope\n  }\n\n  toAuthHeader () {\n    return 'Bearer ' + this.accessToken\n  }\n}\n\nexport function registerClient (cozy, client) {\n  if (!(client instanceof Client)) {\n    client = new Client(client)\n  }\n  if (client.isRegistered()) {\n    return Promise.reject(new Error('Client already registered'))\n  }\n  return cozyFetchJSON(cozy, 'POST', '/auth/register', client.toRegisterJSON(), {\n    disableAuth: true\n  })\n    .then((data) => new Client(data))\n}\n\n// getClient will retrive the registered client informations from the server.\nexport function getClient (cozy, client) {\n  if (!(client instanceof Client)) {\n    client = new Client(client)\n  }\n  if (!client.isRegistered()) {\n    return Promise.reject(new Error('Client not registered'))\n  }\n  return cozyFetchJSON(cozy, 'GET', `/auth/register/${client.clientID}`, null, {\n    manualAuthCredentials: {\n      client: client,\n      token: client\n    }\n  })\n    .then((data) => new Client(data))\n}\n\n// getAuthCodeURL returns a pair {authURL,state} given a registered client. The\n// state should be stored in order to be checked against on the user validation\n// phase.\nexport function getAuthCodeURL (cozy, client, scopes = []) {\n  if (!(client instanceof Client)) {\n    client = new Client(client)\n  }\n  if (!client.isRegistered()) {\n    throw new Error('Client not registered')\n  }\n  const state = generateRandomState()\n  const query = {\n    'client_id': client.clientID,\n    'redirect_uri': client.redirectURI,\n    'state': state,\n    'response_type': 'code',\n    'scope': scopes.join(' ')\n  }\n  return {\n    url: `${cozy.url}/auth/authorize?${encodeQuery(query)}`,\n    state: state\n  }\n}\n\n// getAccessToken perform a request on the access_token entrypoint with the\n// authorization_code grant type in order to generate a new access token for a\n// newly registered client.\n//\n// This method extracts the access code and state from the given URL. By\n// default it uses window.location.href. Also, it checks the given state with\n// the one specified in the URL query parameter to prevent CSRF attacks.\nexport function getAccessToken (cozy, client, state, pageURL = '') {\n  if (!state) {\n    return Promise.reject(new Error('Missing state value'))\n  }\n  const grantQueries = getGrantCodeFromPageURL(pageURL)\n  if (grantQueries === null) {\n    return Promise.reject(new Error('Missing states from current URL'))\n  }\n  if (state !== grantQueries.state) {\n    return Promise.reject(new Error('Given state does not match url query state'))\n  }\n  return retrieveToken(cozy, client, null, {\n    'grant_type': 'authorization_code',\n    'code': grantQueries.code\n  })\n}\n\n// refreshToken perform a request on the access_token entrypoint with the\n// refresh_token grant type in order to refresh the given token.\nexport function refreshToken (cozy, client, token) {\n  return retrieveToken(cozy, client, token, {\n    'grant_type': 'refresh_token',\n    'code': token.refreshToken\n  })\n}\n\n// oauthFlow perform the stateful registration and access granting of an OAuth\n// client.\nexport function oauthFlow (cozy, storage, pageURL, createClient, onRegistered) {\n  function clearAndRetry () {\n    return storage.clear().then(() =>\n      oauthFlow(cozy, storage, pageURL, createClient, onRegistered))\n  }\n\n  function registerNewClient () {\n    const {client: unregisteredClient, scopes} = createClient()\n\n    return storage.clear()\n      .then(() => registerClient(cozy, unregisteredClient))\n      .then((client) => {\n        const {url, state} = getAuthCodeURL(cozy, client, scopes)\n        return storage.save(StateKey, {client, url, state}).then(() => {\n          onRegistered(client, url)\n          // return a promise that never resolves\n          return new Promise(() => {})\n        })\n      })\n  }\n\n  function saveCreds (creds) {\n    storage.delete(StateKey)\n    return storage.save(CredsKey, creds).then(() => creds)\n  }\n\n  function doFlow (credentials, state) {\n    if (!credentials) {\n      // Try to get granted of a token if the state is already filled.\n      if (!getGrantCodeFromPageURL(pageURL)) {\n        onRegistered(client, url)\n        // return a promise that never resolves\n        return new Promise(() => {})\n      }\n\n      const {client, state: value, url} = state\n      return getAccessToken(cozy, client, value, pageURL)\n        .then((token) => ({client, token}))\n    }\n\n    // If credentials are cached we re-fetch the registered client with the\n    // said token. Fetching the client, if the token is outdated we should try\n    // the token is refreshed.\n    const {client, token} = credentials\n    return getClient(cozy, client)\n      .then((client) => ({client, token}))\n  }\n\n  return Promise.all([\n    storage.load(CredsKey),\n    storage.load(StateKey)\n  ]).then(([credentials, state]) => {\n    // The cache is empty, we initiate the client registration.\n    if (!credentials && !state) {\n      return registerNewClient()\n    }\n\n    const authFlow = doFlow(credentials, state)\n\n    // If the auth flow is rejected with a 401 error, we clear the cache and\n    // restart the entire registration flow.\n    return authFlow.then(saveCreds, (err) => {\n      if ((err instanceof FetchError) && err.isUnauthorised()) {\n        return clearAndRetry()\n      } else {\n        throw err\n      }\n    })\n  })\n}\n\n// retrieveToken perform a request on the access_token entrypoint in order to\n// fetch a token.\nfunction retrieveToken (cozy, client, token, query) {\n  if (!(client instanceof Client)) {\n    client = new Client(client)\n  }\n  if (!client.isRegistered()) {\n    return Promise.reject(new Error('Client not registered'))\n  }\n  const body = encodeQuery(Object.assign({}, query, {\n    'client_id': client.clientID,\n    'client_secret': client.clientSecret\n  }))\n  return cozyFetchJSON(cozy, 'POST', '/auth/access_token', body, {\n    disableAuth: (token === null),\n    manualAuthCredentials: { client, token },\n    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }\n  })\n    .then((data) => new AccessToken(data))\n}\n\n// getGrantCodeFromPageURL extract the state and access_code query parameters\n// from the given url\nfunction getGrantCodeFromPageURL (pageURL = '') {\n  if (pageURL === '' && typeof window !== 'undefined') {\n    pageURL = window.location.href\n  }\n  const queries = decodeQuery(pageURL)\n  if (!queries.hasOwnProperty('state')) {\n    return null\n  }\n  return {\n    state: queries['state'],\n    code: queries['access_code']\n  }\n}\n\n// generateRandomState will try to generate a 128bits random value from a secure\n// pseudo random generator. It will fallback on Math.random if it cannot find\n// such generator.\nfunction generateRandomState () {\n  let buffer\n  if (typeof window !== 'undefined' &&\n      typeof window.crypto !== 'undefined' &&\n      typeof window.crypto.getRandomValues === 'function') {\n    buffer = new Uint8Array(StateSize)\n    window.crypto.getRandomValues(buffer)\n  } else {\n    try {\n      buffer = require('crypto').randomBytes(StateSize)\n    } catch (e) {}\n  }\n  if (!buffer) {\n    buffer = new Array(StateSize)\n    for (let i = 0; i < buffer.length; i++) {\n      buffer[i] = Math.floor((Math.random() * 255))\n    }\n  }\n  return btoa(String.fromCharCode.apply(null, buffer))\n    .replace(/=+$/, '')\n    .replace(/\\//g, '_')\n    .replace(/\\+/g, '-')\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/auth_v3.js","function indexKey (doc) {\n  return doc.type + '/' + doc.id\n}\n\nfunction findByRef (resources, ref) {\n  return resources[indexKey(ref)]\n}\n\nfunction handleResource (rawResource, resources) {\n  let resource = {\n    _id: rawResource.id,\n    _type: rawResource.type,\n    _rev: rawResource.meta.rev,\n    attributes: rawResource.attributes,\n    relations: (name) => {\n      let rels = rawResource.relationships[name]\n      if (rels === undefined || rels.data === undefined) return undefined\n      if (rels.data === null) return null\n      if (!Array.isArray(rels.data)) return findByRef(resources, rels.data)\n      return rels.data.map(ref => findByRef(resources, ref))\n    }\n  }\n\n  resources[indexKey(rawResource)] = resource\n\n  return resource\n}\n\nfunction handleTopLevel (doc, resources = {}) {\n  // build an index of included resource by Type & ID\n  const included = doc.included\n\n  if (Array.isArray(included)) {\n    included.forEach((r) => handleResource(r, resources))\n  }\n\n  if (Array.isArray(doc.data)) {\n    return doc.data.map((r) => handleResource(r, resources))\n  } else {\n    return handleResource(doc.data, resources)\n  }\n}\n\nexport default handleTopLevel\n\n\n\n// WEBPACK FOOTER //\n// ./src/jsonapi.js","export class LocalStorage {\n  constructor (storage, prefix) {\n    if (!storage && typeof window !== 'undefined') {\n      storage = window.localStorage\n    }\n    this.storage = storage\n    this.prefix = prefix || 'cozy:oauth:'\n  }\n\n  save (key, value) {\n    return new Promise(resolve => resolve(\n      this.storage.setItem(this.prefix + key, JSON.stringify(value))))\n  }\n\n  load (key) {\n    return new Promise(resolve => {\n      const item = this.storage.getItem(this.prefix + key)\n      if (!item) {\n        resolve()\n      } else {\n        resolve(JSON.parse(item))\n      }\n    })\n  }\n\n  delete (key) {\n    return new Promise(resolve => resolve(\n      this.storage.removeItem(this.prefix + key)))\n  }\n\n  clear () {\n    return new Promise(resolve => {\n      const storage = this.storage\n      for (let i = 0; i < storage.length; i++) {\n        const key = storage.key(i)\n        if (key.indexOf(this.prefix) === 0) {\n          storage.removeItem(key)\n        }\n      }\n      resolve()\n    })\n  }\n}\n\nexport class MemoryStorage {\n  constructor () {\n    this.hash = Object.create(null)\n  }\n\n  save (key, value) {\n    this.hash[key] = value\n    return Promise.resolve(value)\n  }\n\n  load (key) {\n    return Promise.resolve(this.hash[key])\n  }\n\n  delete (key) {\n    const deleted = delete this.hash[key]\n    return Promise.resolve(deleted)\n  }\n\n  clear () {\n    this.hash = Object.create(null)\n    return Promise.resolve()\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/auth_storage.js","/* global btoa */\nconst V2TOKEN_ABORT_TIMEOUT = 3000\n\nexport function getAccessToken () {\n  return new Promise(function (resolve, reject) {\n    if (typeof window === 'undefined') {\n      return reject(new Error('getV2Token should be used in browser'))\n    } else if (!window.parent) {\n      return reject(new Error('getV2Token should be used in iframe'))\n    } else if (!window.parent.postMessage) {\n      return reject(new Error('getV2Token should be used in modern browser'))\n    }\n    const origin = window.location.origin\n    const intent = {action: 'getToken'}\n    let timeout = null\n    const receiver = function (event) {\n      let token\n      try {\n        token = new AccessToken({\n          appName: event.data.appName,\n          token: event.data.token\n        })\n      } catch (e) {\n        reject(e)\n        return\n      }\n      window.removeEventListener('message', receiver)\n      clearTimeout(timeout)\n      resolve({ client: null, token })\n    }\n    window.addEventListener('message', receiver, false)\n    window.parent.postMessage(intent, origin)\n    timeout = setTimeout(() => {\n      reject(new Error('No response from parent iframe after 3s'))\n    }, V2TOKEN_ABORT_TIMEOUT)\n  })\n}\n\nexport class AccessToken {\n  constructor (opts) {\n    this.appName = opts.appName || ''\n    this.token = opts.token || ''\n  }\n\n  toAuthHeader () {\n    return 'Basic ' + btoa(`${this.appName}:${this.token}`)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/auth_v2.js","import {createPath} from './utils'\nimport {normalizeDoctype} from './doctypes'\nimport {cozyFetchJSON} from './fetch'\n\nconst NOREV = 'stack-v2-no-rev'\n\nexport function create (cozy, doctype, attributes) {\n  doctype = normalizeDoctype(cozy, doctype)\n\n  if (cozy.isV2) {\n    attributes.docType = doctype\n  }\n\n  const path = createPath(cozy, doctype)\n  return cozyFetchJSON(cozy, 'POST', path, attributes)\n    .then((resp) => {\n      if (cozy.isV2) {\n        return find(cozy, doctype, resp._id)\n      } else {\n        return resp.data\n      }\n    })\n}\n\nexport function find (cozy, doctype, id) {\n  doctype = normalizeDoctype(cozy, doctype)\n\n  if (!id) {\n    return Promise.reject(new Error('Missing id parameter'))\n  }\n\n  const path = createPath(cozy, doctype, id)\n  return cozyFetchJSON(cozy, 'GET', path)\n    .then((resp) => {\n      if (cozy.isV2) {\n        return Object.assign(resp, {_rev: NOREV})\n      } else {\n        return resp\n      }\n    })\n}\n\nexport function update (cozy, doctype, doc, changes) {\n  doctype = normalizeDoctype(cozy, doctype)\n\n  const {_id, _rev} = doc\n\n  if (!_id) {\n    return Promise.reject(new Error('Missing _id field in passed document'))\n  }\n\n  if (!cozy.isV2 && !_rev) {\n    return Promise.reject(new Error('Missing _rev field in passed document'))\n  }\n\n  if (cozy.isV2) {\n    changes = Object.assign({ _id }, changes)\n  } else {\n    changes = Object.assign({ _id, _rev }, changes)\n  }\n\n  const path = createPath(cozy, doctype, _id)\n  return cozyFetchJSON(cozy, 'PUT', path, changes)\n    .then((resp) => {\n      if (cozy.isV2) {\n        return find(cozy, doctype, _id)\n      } else {\n        return resp.data\n      }\n    })\n}\n\nexport function updateAttributes (cozy, doctype, _id, changes, tries = 3) {\n  doctype = normalizeDoctype(cozy, doctype)\n  return find(cozy, doctype, _id)\n    .then((doc) => {\n      return update(cozy, doctype, doc, Object.assign({ _id }, doc, changes))\n    })\n    .catch((err) => {\n      if (tries > 0) {\n        return updateAttributes(cozy, doctype, _id, changes, tries - 1)\n      } else {\n        throw err\n      }\n    })\n}\n\nexport function _delete (cozy, doctype, doc) {\n  doctype = normalizeDoctype(cozy, doctype)\n\n  const {_id, _rev} = doc\n\n  if (!_id) {\n    return Promise.reject(new Error('Missing _id field in passed document'))\n  }\n\n  if (!cozy.isV2 && !_rev) {\n    return Promise.reject(new Error('Missing _rev field in passed document'))\n  }\n\n  const query = cozy.isV2 ? null : { rev: _rev }\n  const path = createPath(cozy, doctype, _id, query)\n  return cozyFetchJSON(cozy, 'DELETE', path)\n    .then((resp) => {\n      if (cozy.isV2) {\n        return {id: _id, rev: NOREV}\n      } else {\n        return resp\n      }\n    })\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/crud.js","import {warn} from './utils'\n\nconst KNOWN_DOCTYPES = {\n  'files': 'io.cozy.files',\n  'folder': 'io.cozy.files',\n  'contact': 'io.cozy.contacts',\n  'event': 'io.cozy.events',\n  'track': 'io.cozy.labs.music.track',\n  'playlist': 'io.cozy.labs.music.playlist'\n}\n\nconst REVERSE_KNOWN = {}\nObject.keys(KNOWN_DOCTYPES).forEach(k => {\n  REVERSE_KNOWN[KNOWN_DOCTYPES[k]] = k\n})\n\nexport function normalizeDoctype (cozy, doctype) {\n  let isQualified = doctype.indexOf('.') !== -1\n  if (cozy.isV2 && isQualified) {\n    let known = REVERSE_KNOWN[doctype]\n    if (known) return known\n    return doctype.replace(/\\./g, '-')\n  }\n  if (!cozy.isV2 && !isQualified) {\n    let known = KNOWN_DOCTYPES[doctype]\n    if (known) {\n      warn('you are using a non-qualified doctype ' + doctype + ' assumed to be ' + known)\n      return known\n    }\n    throw new Error('Doctype ' + doctype + ' should be qualified.')\n  }\n  return doctype\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/doctypes.js","import {warn, createPath} from './utils'\nimport {normalizeDoctype} from './doctypes'\nimport {cozyFetchJSON} from './fetch'\n\nexport function defineIndex (cozy, doctype, fields) {\n  doctype = normalizeDoctype(cozy, doctype)\n  if (!Array.isArray(fields) || fields.length === 0) {\n    throw new Error('defineIndex fields should be a non-empty array')\n  }\n  if (cozy.isV2) {\n    return defineIndexV2(cozy, doctype, fields)\n  } else {\n    return defineIndexV3(cozy, doctype, fields)\n  }\n}\n\nexport function query (cozy, indexRef, options) {\n  if (!indexRef) {\n    throw new Error('query should be passed the indexRef')\n  }\n  if (cozy.isV2) {\n    return queryV2(cozy, indexRef, options)\n  } else {\n    return queryV3(cozy, indexRef, options)\n  }\n}\n\n// Internals\n\nconst VALUEOPERATORS = ['$eq', '$gt', '$gte', '$lt', '$lte']\nconst LOGICOPERATORS = ['$or', '$and', '$not']\n\n/* eslint-disable */\nconst MAP_TEMPLATE = (function (doc) {\n  if (doc.docType.toLowerCase() === 'DOCTYPEPLACEHOLDER'){\n    emit(FIELDSPLACEHOLDER, doc)\n  }\n}).toString().replace(/ /g, '').replace(/\\n/g, '')\nconst COUCHDB_INFINITY = {\"\\uFFFF\": \"\\uFFFF\"}\nconst COUCHDB_LOWEST = null\n/* eslint-enable */\n\n// defineIndexV2 is equivalent to defineIndex but only works for V2.\n// It transforms the index fields into a map reduce view.\nfunction defineIndexV2 (cozy, doctype, fields) {\n  let indexName = 'by' + fields.map(capitalize).join('')\n  let indexDefinition = { map: makeMapFunction(doctype, fields), reduce: '_count' }\n  let path = `/request/${doctype}/${indexName}/`\n  return cozyFetchJSON(cozy, 'PUT', path, indexDefinition)\n    .then(() => ({ doctype: doctype, type: 'mapreduce', name: indexName, fields: fields }))\n}\n\n// defineIndexV2 is equivalent to defineIndex but only works for V2.\n// It transforms the index fields into a map reduce view.\nfunction defineIndexV3 (cozy, doctype, fields) {\n  let path = createPath(cozy, doctype, '_index')\n  let indexDefinition = {'index': {fields}}\n  return cozyFetchJSON(cozy, 'POST', path, indexDefinition)\n    .then((response) => ({ doctype: doctype, type: 'mango', name: response.id, fields: fields }))\n}\n\n// queryV2 is equivalent to query but only works for V2.\n// It transforms the query into a _views call using makeMapReduceQuery\nfunction queryV2 (cozy, indexRef, options) {\n  if (indexRef.type !== 'mapreduce') {\n    throw new Error('query indexRef should be the return value of defineIndexV2')\n  }\n  if (options.fields) {\n    warn('query fields will be ignored on v2')\n  }\n\n  let path = `/request/${indexRef.doctype}/${indexRef.name}/`\n  let opts = makeMapReduceQuery(indexRef, options)\n  return cozyFetchJSON(cozy, 'POST', path, opts)\n    .then((response) => response.map(r => r.value))\n}\n\n// queryV3 is equivalent to query but only works for V3\nfunction queryV3 (cozy, indexRef, options) {\n  if (indexRef.type !== 'mango') {\n    throw new Error('indexRef should be the return value of defineIndexV3')\n  }\n\n  let opts = {\n    use_index: indexRef.name,\n    fields: options.fields,\n    selector: options.selector,\n    limit: options.limit,\n    since: options.since,\n    sort: indexRef.fields // sort is useless with mango\n  }\n\n  let path = createPath(cozy, indexRef.doctype, '_find')\n  return cozyFetchJSON(cozy, 'POST', path, opts)\n    .then((response) => response.docs)\n}\n\n// misc\nfunction capitalize (name) {\n  return name.charAt(0).toUpperCase() + name.slice(1)\n}\n\nfunction makeMapFunction (doctype, fields) {\n  fields = '[' + fields.map(name => 'doc.' + name).join(',') + ']'\n\n  return MAP_TEMPLATE.replace('DOCTYPEPLACEHOLDER', doctype.toLowerCase())\n                     .replace('FIELDSPLACEHOLDER', fields)\n}\n\n// parseSelector takes a mango selector and returns it as an array of filter\n// a filter is [path, operator, value] array\n// a path is an array of field names\n// This function is only exported so it can be unit tested.\n// Example :\n// parseSelector({\"test\":{\"deep\": {\"$gt\": 3}}})\n// [[['test', 'deep'], '$gt', 3 ]]\nexport function parseSelector (selector, path = [], operator = '$eq') {\n  if ((typeof selector) !== 'object') {\n    return [[path, operator, selector]]\n  }\n\n  let keys = Object.keys(selector)\n  if (keys.length === 0) {\n    throw new Error('empty selector')\n  } else {\n    return keys.reduce(function (acc, k) {\n      if (LOGICOPERATORS.indexOf(k) !== -1) {\n        throw new Error('cozy-client-js does not support mango logic ops')\n      } else if (VALUEOPERATORS.indexOf(k) !== -1) {\n        return acc.concat(parseSelector(selector[k], path, k))\n      } else {\n        return acc.concat(parseSelector(selector[k], path.concat(k), '$eq'))\n      }\n    }, [])\n  }\n}\n\n// normalizeSelector takes a mango selector and returns it as an object\n// normalized.\n// This function is only exported so it can be unit tested.\n// Example :\n// parseSelector({\"test\":{\"deep\": {\"$gt\": 3}}})\n// {\"test.deep\": {\"$gt\": 3}}\nexport function normalizeSelector (selector) {\n  var filters = parseSelector(selector)\n  return filters.reduce(function (acc, filter) {\n    let [path, op, value] = filter\n    let field = path.join('.')\n    acc[field] = acc[field] || {}\n    acc[field][op] = value\n    return acc\n  }, {})\n}\n\n// applySelector takes the normalized selector for the current field\n// and append the proper values to opts.startkey, opts.endkey\nfunction applySelector (selector, opts) {\n  let value = selector['$eq']\n  let lower = COUCHDB_LOWEST\n  let upper = COUCHDB_INFINITY\n  let inclusiveEnd\n\n  if (value) {\n    opts.startkey.push(value)\n    opts.endkey.push(value)\n    return false\n  }\n\n  value = selector['$gt']\n  if (value) {\n    throw new Error('operator $gt (strict greater than) not supported')\n  }\n\n  value = selector['$gte']\n  if (value) {\n    lower = value\n  }\n\n  value = selector['$lte']\n  if (value) {\n    upper = value\n    inclusiveEnd = true\n  }\n\n  value = selector['$lt']\n  if (value) {\n    upper = value\n    inclusiveEnd = false\n  }\n\n  opts.startkey.push(lower)\n  opts.endkey.push(upper)\n  if (inclusiveEnd !== undefined) opts.inclusive_end = inclusiveEnd\n  return true\n}\n\n// makeMapReduceQuery takes a mango query and generate _views call parameters\n// to obtain same results depending on fields in the passed indexRef.\nexport function makeMapReduceQuery (indexRef, query) {\n  let mrquery = {\n    startkey: [],\n    endkey: [],\n    reduce: false\n  }\n  let firstFreeValueField = null\n  let normalizedSelector = normalizeSelector(query.selector)\n\n  indexRef.fields.forEach(function (field) {\n    let selector = normalizedSelector[field]\n\n    if (selector && firstFreeValueField != null) {\n      throw new Error('Selector on field ' + field + ', but not on ' + firstFreeValueField + ' which is higher in index fields.')\n    } else if (selector) {\n      selector.used = true\n      let isFreeValue = applySelector(selector, mrquery)\n      if (isFreeValue) firstFreeValueField = field\n    } else if (firstFreeValueField == null) {\n      firstFreeValueField = field\n      mrquery.endkey.push(COUCHDB_INFINITY)\n    }\n  })\n\n  Object.keys(normalizedSelector).forEach(function (field) {\n    if (!normalizedSelector[field].used) {\n      throw new Error('Cant apply selector on ' + field + ', it is not in index')\n    }\n  })\n\n  return mrquery\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/mango.js","/* global Blob, File */\nimport {cozyFetch, cozyFetchJSON} from './fetch'\nimport jsonapi from './jsonapi'\n\nconst contentTypeOctetStream = 'application/octet-stream'\n\nfunction doUpload (cozy, data, contentType, method, path) {\n  if (!data) {\n    throw new Error('missing data argument')\n  }\n\n  // transform any ArrayBufferView to ArrayBuffer\n  if (data.buffer && data.buffer instanceof ArrayBuffer) {\n    data = data.buffer\n  }\n\n  const isBuffer = (typeof ArrayBuffer !== 'undefined' && data instanceof ArrayBuffer)\n  const isFile = (typeof File !== 'undefined' && data instanceof File)\n  const isBlob = (typeof Blob !== 'undefined' && data instanceof Blob)\n  const isString = (typeof data === 'string')\n\n  if (!isBuffer && !isFile && !isBlob && !isString) {\n    throw new Error('invalid data type')\n  }\n\n  if (!contentType) {\n    if (isBuffer) {\n      contentType = contentTypeOctetStream\n    } else if (isFile) {\n      contentType = data.type || contentTypeOctetStream\n    } else if (isBlob) {\n      contentType = contentTypeOctetStream\n    } else if (typeof data === 'string') {\n      contentType = 'text/plain'\n    }\n  }\n\n  return cozyFetch(cozy, path, {\n    method: method,\n    headers: { 'Content-Type': contentType },\n    body: data\n  })\n    .then((res) => {\n      const json = res.json()\n      if (!res.ok) {\n        return json.then(err => { throw err })\n      } else {\n        return json.then(jsonapi)\n      }\n    })\n}\n\nexport function create (cozy, data, options) {\n  let {name, dirID, contentType} = options || {}\n\n  // handle case where data is a file and contains the name\n  if (!name && typeof data.name === 'string') {\n    name = data.name\n  }\n\n  if (typeof name !== 'string' || name === '') {\n    throw new Error('missing name argument')\n  }\n\n  const path = `/files/${encodeURIComponent(dirID || '')}`\n  const query = `?Name=${encodeURIComponent(name)}&Type=file`\n  return doUpload(cozy, data, contentType, 'POST', `${path}${query}`)\n}\n\nexport function createDirectory (cozy, options) {\n  const {name, dirID} = options || {}\n\n  if (typeof name !== 'string' || name === '') {\n    throw new Error('missing name argument')\n  }\n\n  const path = `/files/${encodeURIComponent(dirID || '')}`\n  const query = `?Name=${encodeURIComponent(name)}&Type=directory`\n  return cozyFetchJSON(cozy, 'POST', `${path}${query}`)\n}\n\nexport function updateById (cozy, id, data, options) {\n  const {contentType} = options || {}\n  return doUpload(cozy, data, contentType, 'PUT', `/files/${encodeURIComponent(id)}`)\n}\n\nexport function updateAttributesById (cozy, id, attrs) {\n  if (!attrs || typeof attrs !== 'object') {\n    throw new Error('missing attrs argument')\n  }\n\n  const body = { data: { attributes: attrs } }\n  return cozyFetchJSON(cozy, 'PATCH',\n    `/files/${encodeURIComponent(id)}`, body)\n}\n\nexport function updateAttributesByPath (cozy, path, attrs) {\n  if (!attrs || typeof attrs !== 'object') {\n    throw new Error('missing attrs argument')\n  }\n\n  const body = { data: { attributes: attrs } }\n  return cozyFetchJSON(cozy, 'PATCH',\n    `/files/metadata?Path=${encodeURIComponent(path)}`, body)\n}\n\nexport function trashById (cozy, id) {\n  if (typeof id !== 'string' || id === '') {\n    throw new Error('missing id argument')\n  }\n  return cozyFetchJSON(cozy, 'DELETE', `/files/${encodeURIComponent(id)}`)\n}\n\nexport function statById (cozy, id) {\n  return cozyFetchJSON(cozy, 'GET', `/files/${encodeURIComponent(id)}`)\n    .then(addIsDir)\n}\n\nexport function statByPath (cozy, path) {\n  return cozyFetchJSON(cozy, 'GET', `/files/metadata?Path=${encodeURIComponent(path)}`)\n    .then(addIsDir)\n}\n\nexport function downloadById (cozy, id) {\n  return cozyFetch(cozy, `/files/download/${encodeURIComponent(id)}`)\n}\n\nexport function downloadByPath (cozy, path) {\n  return cozyFetch(cozy, `/files/download?Path=${encodeURIComponent(path)}`)\n}\n\nfunction addIsDir (obj) {\n  obj.isDir = obj.attributes.type === 'directory'\n  return obj\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/files.js"],"sourceRoot":""}